<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة الأدمن — Aya Elsayed</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header">
    <h1>لوحة الأدمن — Aya Elsayed</h1>
    <div><a href="index.html" style="color:#fff">عرض المتجر</a></div>
  </header>

  <div class="container">
    <div id="adminArea">
      <p>جارٍ التحقق...</p>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./supabase.js";

    const SECRET = "REPLACE_WITH_SECRET"; // غيّره بقيمة قوية قبل الإطلاق
    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    const adminArea = document.getElementById('adminArea');

    if(token !== SECRET){
      adminArea.innerHTML = `<p style="color:red">رمز الوصول غير صحيح.</p>`;
      throw new Error('Unauthorized');
    }

    // بعد التحقق: render admin UI
    adminArea.innerHTML = `
      <div class="admin-header">
        <h2>إدارة المنتجات والطلبات</h2>
        <div>
          <button id="refresh" class="btn">تحديث</button>
        </div>
      </div>

      <div class="kpi">
        <div class="card"><div id="totalProducts">-</div><div>عدد المنتجات</div></div>
        <div class="card"><div id="totalOrders">-</div><div>عدد الطلبات</div></div>
        <div class="card"><div id="totalRevenue">-</div><div>إجمالي المبيعات (جنيه)</div></div>
      </div>

      <section style="margin-bottom:12px">
        <h3>إضافة منتج جديد</h3>
        <form id="addProduct" style="display:grid;gap:8px;max-width:600px">
          <input id="title" placeholder="اسم المنتج" required>
          <textarea id="desc" placeholder="وصف المنتج"></textarea>
          <input id="price" type="number" placeholder="السعر (جنيه)" required>
          <input id="imageUrl" placeholder="رابط الصورة (أو ارفع في Storage)">
          <button class="btn" type="submit">إضافة</button>
        </form>
      </section>

      <section>
        <h3>المنتجات</h3>
        <table class="table" id="productsTable">
          <thead><tr><th>عنوان</th><th>سعر</th><th>أعمال</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section style="margin-top:18px">
        <h3>الطلبات</h3>
        <table class="table" id="ordersTable">
          <thead><tr><th>العميل</th><th>الهاتف</th><th>الطلبات</th><th>المجموع</th><th>الحالة</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    `;

    // DOM refs
    const addProductForm = document.getElementById('addProduct');
    const productsTable = document.querySelector('#productsTable tbody');
    const ordersTable = document.querySelector('#ordersTable tbody');
    const totalProducts = document.getElementById('totalProducts');
    const totalOrders = document.getElementById('totalOrders');
    const totalRevenue = document.getElementById('totalRevenue');
    const refreshBtn = document.getElementById('refresh');

    async function loadAdmin(){
      // products
      const { data: products, error: pErr } = await supabase.from('products').select('*').order('created_at',{ascending:false});
      if(pErr){ console.error(pErr); return; }
      productsTable.innerHTML = products.map(p => `
        <tr data-id="${p.id}">
          <td>${p.title}</td>
          <td>${p.price}</td>
          <td>
            <button class="btn" data-del="${p.id}">حذف</button>
            <button class="btn ghost" data-edit="${p.id}">تعديل</button>
            <button class="btn ghost" data-stats="${p.id}">عدد الطلبات</button>
          </td>
        </tr>
      `).join('');
      totalProducts.textContent = products.length;

      // orders
      const { data: orders, error: oErr } = await supabase.from('orders').select('*').order('created_at',{ascending:false});
      if(oErr){ console.error(oErr); return; }
      ordersTable.innerHTML = orders.map(o => `
        <tr>
          <td>${o.customer_name}</td>
          <td>${o.phone}</td>
          <td>${(JSON.parse(o.items||'[]')).map(it=>it.title + ' x'+it.quantity).join('<br>')}</td>
          <td>${o.total}</td>
          <td>${o.status}</td>
        </tr>
      `).join('');
      totalOrders.textContent = orders.length;
      totalRevenue.textContent = orders.reduce((s,o)=>s + parseFloat(o.total||0), 0);

      // attach delete events
      document.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del');
          if(!confirm('هل تريد حذف المنتج؟')) return;
          const { error } = await supabase.from('products').delete().eq('id', id);
          if(error){ alert('حدث خطأ'); console.error(error); }
          else loadAdmin();
        });
      });

      // attach stats button: count orders that include product id
      document.querySelectorAll('[data-stats]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const pid = btn.getAttribute('data-stats');
          // query orders where items::jsonb contains product id
          const { data: orders, error } = await supabase.rpc('count_orders_for_product', {p_product_id: pid});
          if(error){ console.error(error); alert('خطأ في جلب الإحصائيات'); return; }
          alert('عدد الطلبات التي اشتملت على المنتج: ' + (orders?.count || 0));
        });
      });

    }

    // add product
    addProductForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const price = document.getElementById('price').value;
      const imageUrl = document.getElementById('imageUrl').value.trim();

      const { error } = await supabase.from('products').insert([{ title, description: desc, price, image_url: imageUrl }]);
      if(error){ alert('حدث خطأ'); console.error(error); return; }
      addProductForm.reset();
      loadAdmin();
    });

    refreshBtn.addEventListener('click', loadAdmin);

    // initial
    loadAdmin();

  </script>
</body>
</html>
