<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة الأدمن — Aya Elsayed</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header class="header">
    <h1>لوحة الأدمن — Aya Elsayed</h1>
    <div><a href="index.html" style="color:#fff">عرض المتجر</a></div>
  </header>

  <div class="container">
    <div id="adminArea"><p>جارٍ التحقق...</p></div>
  </div>

<script type="module">
import { supabase } from "./supabase.js";

const SECRET = "Alosh123@@@";
const params = new URLSearchParams(location.search);
const token = params.get("token");
const adminArea = document.getElementById("adminArea");

// =============================
// التحقق من الدخول
// =============================
if (token !== SECRET) {
  adminArea.innerHTML = `<p style="color:red">رمز الدخول غير صحيح ❌</p>`;
  throw new Error("Unauthorized");
}

// =============================
// واجهة الأدمن
// =============================
adminArea.innerHTML = `
  <div class="admin-header">
    <h2>إدارة المنتجات والطلبات</h2>
    <button id="refresh" class="btn">تحديث</button>
  </div>

  <div class="kpi">
    <div class="card"><div id="totalProducts">-</div><div>عدد المنتجات</div></div>
    <div class="card"><div id="totalOrders">-</div><div>عدد الطلبات</div></div>
    <div class="card"><div id="totalRevenue">-</div><div>إجمالي المبيعات (جنيه)</div></div>
  </div>

  <section style="margin-bottom:12px">
    <h3>إضافة منتج جديد</h3>
    <form id="addProduct" style="display:grid;gap:8px;max-width:600px">
      <input id="title" placeholder="اسم المنتج" required>
      <textarea id="desc" placeholder="وصف المنتج"></textarea>
      <input id="price" type="number" placeholder="السعر (جنيه)" required>
      
      <label>صورة المنتج:</label>
      <input id="imageFile" type="file" accept="image/*">

      <button class="btn" type="submit">إضافة</button>
    </form>
  </section>

  <section>
    <h3>المنتجات</h3>
    <table class="table" id="productsTable">
      <thead><tr><th>المنتج</th><th>السعر</th><th>إدارة</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top:18px">
    <h3>الطلبات</h3>
    <table class="table" id="ordersTable">
      <thead><tr><th>العميل</th><th>الهاتف</th><th>الطلب</th><th>المجموع</th><th>الحالة</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
`;

// =============================
// عناصر DOM
// =============================
const addProductForm = document.getElementById("addProduct");
const productsTable = document.querySelector("#productsTable tbody");
const ordersTable = document.querySelector("#ordersTable tbody");
const totalProducts = document.getElementById("totalProducts");
const totalOrders = document.getElementById("totalOrders");
const totalRevenue = document.getElementById("totalRevenue");
const refreshBtn = document.getElementById("refresh");

// =============================
// تحميل المنتجات + الطلبات
// =============================
async function loadAdmin() {

  // تحميل المنتجات
  const { data: products, error: pErr } = await supabase
    .from("products")
    .select("*")
    .order("created_at", { ascending: false });

  if (pErr) return console.error(pErr);

  productsTable.innerHTML = products
    .map(
      (p) => `
    <tr>
      <td>${p.title}</td>
      <td>${p.price}</td>
      <td>
        <button class="btn" data-del="${p.id}">حذف</button>
      </td>
    </tr>
  `
    )
    .join("");

  totalProducts.textContent = products.length;

  // زرار الحذف
  document.querySelectorAll("[data-del]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.del;
      if (!confirm("هل تريد حذف المنتج؟")) return;

      await supabase.from("products").delete().eq("id", id);
      loadAdmin();
    });
  });

  // =============================
  // تحميل الطلبات
  // =============================
  const { data: orders, error: oErr } = await supabase
    .from("orders")
    .select("*")
    .order("created_at", { ascending: false });

  if (oErr) return console.error(oErr);

  ordersTable.innerHTML = orders
    .map(
      (o) => `
    <tr>
      <td>${o.customer_name}</td>
      <td>${o.phone}</td>
      <td>${
        (o.items || [])
          .map((i) => `${i.title} × ${i.quantity}`)
          .join("<br>")
      }</td>
      <td>${o.total}</td>
      <td>${o.status}</td>
    </tr>
  `
    )
    .join("");

  totalOrders.textContent = orders.length;
  totalRevenue.textContent = orders.reduce(
    (sum, o) => sum + Number(o.total || 0),
    0
  );
}

refreshBtn.addEventListener("click", loadAdmin);

// =============================
// إضافة منتج
// =============================
addProductForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("title").value.trim();
  const desc = document.getElementById("desc").value.trim();
  const price = document.getElementById("price").value;
  const file = document.getElementById("imageFile").files[0];

  let finalImageUrl = null;

  // رفع صورة المنتج
  if (file) {
    const fileName = `products/${Date.now()}_${file.name}`;

    const { error: uploadError } = await supabase.storage
      .from("products-images")
      .upload(fileName, file);

    if (uploadError) {
      alert("فشل رفع الصورة");
      console.error(uploadError);
      return;
    }

    const { data: urlData } = supabase.storage
      .from("products-images")
      .getPublicUrl(fileName);

    finalImageUrl = urlData.publicUrl;
  }

  // إدخال المنتج
  const { error } = await supabase.from("products").insert([
    {
      title,
      description: desc,
      price,
      image_url: finalImageUrl,
    },
  ]);

  if (error) {
    alert("فشل إضافة المنتج");
    console.error(error);
    return;
  }

  alert("✔️ تم إضافة المنتج بنجاح");
  addProductForm.reset();
  loadAdmin();
});

// تحميل أولي
loadAdmin();
</script>

</body>
</html>
