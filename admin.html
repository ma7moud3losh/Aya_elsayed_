<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة الأدمن — Aya Elsayed</title>
  <link rel="stylesheet" href="style.css">

  <style>
/* ===== صفحة الأدمن - تنسيق عام ===== */
body {
  font-family: "Tajawal", sans-serif;
  background: #fff7fb;
  margin: 0;
  padding: 0;
}

.header {
  background: #ff7aa8;
  padding: 15px;
  color: #fff;
  font-size: 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container { padding: 20px; }

.btn {
  background: #ff7aa8;
  padding: 8px 14px;
  border: none;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
}
.btn:hover { background: #ff5c90; }

.table, .orders-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

.table th, .orders-table th {
  background: #ff9fbc;
  color: white;
  padding: 10px;
}

.table td, .orders-table td {
  padding: 10px;
  border-bottom: 1px solid #ffd7e8;
  text-align: center;
}

.orders-table {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(255, 157, 185, 0.3);
}

.orders-table tr:hover { background: #fff1f7; }

.status-select {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ffb6cf;
}

.delete-btn, .delete-product {
  background: #ff5f7e;
  border: none;
  padding: 7px 12px;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
.delete-btn:hover, .delete-product:hover { background: #e04361; }

  </style>

</head>

<body>

<header class="header">
  <h1>لوحة الأدمن — Aya Elsayed</h1>
  <a href="index.html" style="color:#fff">عرض المتجر</a>
</header>

<div class="container">
  <div id="adminArea"><p>جارٍ التحقق...</p></div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

const SECRET = "Alosh123@@@";
const token = new URLSearchParams(location.search).get("token");
const adminArea = document.getElementById("adminArea");

if (token !== SECRET) {
  adminArea.innerHTML = `<p style="color:red">رمز الدخول غير صحيح ❌</p>`;
  throw new Error("Unauthorized");
}

/* ==========================
   واجهة الأدمن
========================== */
adminArea.innerHTML = `
  <div class="admin-header">
    <h2>إدارة المنتجات والطلبات</h2>
    <button id="refresh" class="btn">تحديث</button>
  </div>

  <section style="margin-bottom:12px">
    <h3>إضافة منتج جديد</h3>
    <form id="addProduct" style="display:grid;gap:8px;max-width:600px">
      <input id="title" placeholder="اسم المنتج" required>
      <textarea id="desc" placeholder="وصف المنتج"></textarea>
      <input id="price" type="number" placeholder="السعر" required>
      <label>صورة المنتج:</label>
      <input id="imageFile" type="file" accept="image/*">
      <button class="btn" type="submit">إضافة</button>
    </form>
  </section>

  <section>
    <h3>المنتجات</h3>
    <table class="table" id="productsTable">
      <thead><tr><th>المنتج</th><th>السعر</th><th>إدارة</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section style="margin-top:18px">
    <h3>الطلبات</h3>
    <table class="orders-table" id="ordersTable">
      <thead>
        <tr>
          <th>العميل</th>
          <th>الهاتف</th>
          <th>الطلب</th>
          <th>المجموع</th>
          <th>الحالة</th>
          <th>إدارة</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
`;

/* ==========================
   عناصر DOM
========================== */
const productsTable = document.querySelector("#productsTable tbody");
const ordersTable = document.querySelector("#ordersTable tbody");
const refreshBtn = document.getElementById("refresh");
const addProductForm = document.getElementById("addProduct");

/* ==========================
   تحميل البيانات
========================== */
async function loadAdmin() {

  /* تحميل المنتجات */
  const { data: products } = await supabase.from("products").select("*");

  productsTable.innerHTML = products
    .map(
      (p) => `
<tr>
  <td>${p.title}</td>
  <td>${p.price} جنيه</td>
  <td>
    <button class="delete-product" data-id="${p.id}">حذف</button>
  </td>
</tr>`
    )
    .join("");

  document.querySelectorAll(".delete-product").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("حذف المنتج؟")) return;
      await supabase.from("products").delete().eq("id", btn.dataset.id);
      loadAdmin();
    });
  });

  /* تحميل الطلبات */
  const { data: orders } = await supabase.from("orders").select("*");

  ordersTable.innerHTML = orders
    .map(
      (o) => `
<tr>
  <td>${o.customer_name}</td>
  <td>${o.phone}</td>
  <td>${o.items.map(i => `${i.title} × ${i.quantity}`).join("<br>")}</td>
  <td>${o.total} جنيه</td>

  <td>
    <select class="status-select" data-id="${o.id}">
      <option value="new" ${o.status === "new" ? "selected" : ""}>جديد</option>
      <option value="processing" ${o.status === "processing" ? "selected" : ""}>جاري التجهيز</option>
      <option value="done" ${o.status === "done" ? "selected" : ""}>تم التسليم</option>
    </select>
  </td>

  <td>
    <button class="delete-btn" data-id="${o.id}">حذف</button>
  </td>
</tr>`
    )
    .join("");

  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("حذف الطلب؟")) return;
      await supabase.from("orders").delete().eq("id", btn.dataset.id);
      loadAdmin();
    });
  });

  document.querySelectorAll(".status-select").forEach((sel) => {
    sel.addEventListener("change", async () => {
      await supabase
        .from("orders")
        .update({ status: sel.value })
        .eq("id", sel.dataset.id);
    });
  });
}

refreshBtn.addEventListener("click", loadAdmin);
loadAdmin();

/* ==========================
   إضافة منتج
========================== */
addProductForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("title").value;
  const desc = document.getElementById("desc").value;
  const price = document.getElementById("price").value;
  const file = document.getElementById("imageFile").files[0];

  let finalImageUrl = null;

  if (file) {
    const fileName = "products/" + Date.now() + "_" + file.name;
    await supabase.storage.from("products-images").upload(fileName, file);
    const { data } = supabase.storage
      .from("products-images")
      .getPublicUrl(fileName);
    finalImageUrl = data.publicUrl;
  }

  await supabase.from("products").insert([
    { title, description: desc, price, image_url: finalImageUrl },
  ]);

  alert("✔ تم إضافة المنتج");
  addProductForm.reset();
  loadAdmin();
});

</script>

</body>
</html>
