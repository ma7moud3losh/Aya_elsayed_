<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Aya Elsayed</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Aya Elsayed</h1>
    <div><a href="index.html" style="color:#fff">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø±</a></div>
  </header>

  <div class="container">
    <div id="adminArea">
      <p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...</p>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./supabase.js";

    const SECRET = "Alosh123@@@"; // ØºÙŠÙ‘Ø±Ù‡ Ø¨Ù‚ÙŠÙ…Ø© Ù‚ÙˆÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚
    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    const adminArea = document.getElementById('adminArea');

    if(token !== SECRET){
      adminArea.innerHTML = `<p style="color:red">Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.</p>`;
      throw new Error('Unauthorized');
    }

    // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚: render admin UI
    adminArea.innerHTML = `
      <div class="admin-header">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
        <div>
          <button id="refresh" class="btn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <div class="kpi">
        <div class="card"><div id="totalProducts">-</div><div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div></div>
        <div class="card"><div id="totalOrders">-</div><div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
        <div class="card"><div id="totalRevenue">-</div><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬Ù†ÙŠÙ‡)</div></div>
      </div>

      <section style="margin-bottom:12px">
        <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
        <form id="addProduct" style="display:grid;gap:8px;max-width:600px">
          <input id="title" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required>
          <textarea id="desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
          <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡)" required>
<label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</label>
<input id="imageFile" type="file" accept="image/*">

<!-- Ø­Ù‚Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹) -->
<input id="imageUrl" type="hidden">
          <button class="btn" type="submit">Ø¥Ø¶Ø§ÙØ©</button>
        </form>
      </section>

      <section>
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
        <table class="table" id="productsTable">
          <thead><tr><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø³Ø¹Ø±</th><th>Ø£Ø¹Ù…Ø§Ù„</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section style="margin-top:18px">
        <h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <table class="table" id="ordersTable">
          <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    `;

    // DOM refs
    const addProductForm = document.getElementById('addProduct');
    const productsTable = document.querySelector('#productsTable tbody');
    const ordersTable = document.querySelector('#ordersTable tbody');
    const totalProducts = document.getElementById('totalProducts');
    const totalOrders = document.getElementById('totalOrders');
    const totalRevenue = document.getElementById('totalRevenue');
    const refreshBtn = document.getElementById('refresh');

    async function loadAdmin(){
      // products
      const { data: products, error: pErr } = await supabase.from('products').select('*').order('created_at',{ascending:false});
      if(pErr){ console.error(pErr); return; }
      productsTable.innerHTML = products.map(p => `
        <tr data-id="${p.id}">
          <td>${p.title}</td>
          <td>${p.price}</td>
          <td>
            <button class="btn" data-del="${p.id}">Ø­Ø°Ù</button>
            <button class="btn ghost" data-edit="${p.id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn ghost" data-stats="${p.id}">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
          </td>
        </tr>
      `).join('');
      totalProducts.textContent = products.length;

      // orders
      const { data: orders, error: oErr } = await supabase.from('orders').select('*').order('created_at',{ascending:false});
      if(oErr){ console.error(oErr); return; }
      ordersTable.innerHTML = orders.map(o => `
        <tr>
          <td>${o.customer_name}</td>
          <td>${o.phone}</td>
          <td>${(JSON.parse(o.items||'[]')).map(it=>it.title + ' x'+it.quantity).join('<br>')}</td>
          <td>${o.total}</td>
          <td>${o.status}</td>
        </tr>
      `).join('');
      totalOrders.textContent = orders.length;
      totalRevenue.textContent = orders.reduce((s,o)=>s + parseFloat(o.total||0), 0);

      // attach delete events
      document.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del');
          if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
          const { error } = await supabase.from('products').delete().eq('id', id);
          if(error){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£'); console.error(error); }
          else loadAdmin();
        });
      });

      // attach stats button: count orders that include product id
      document.querySelectorAll('[data-stats]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const pid = btn.getAttribute('data-stats');
          // query orders where items::jsonb contains product id
          const { data: orders, error } = await supabase.rpc('count_orders_for_product', {p_product_id: pid});
          if(error){ console.error(error); alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'); return; }
          alert('Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ø§Ø´ØªÙ…Ù„Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬: ' + (orders?.count || 0));
        });
      });

    }

    // add product
    addProductForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  console.log("â–¶ï¸ Ø¨Ø¯Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬...");

  const title = document.getElementById("title").value.trim();
  const desc = document.getElementById("desc").value.trim();
  const price = document.getElementById("price").value;
  const file = document.getElementById("imageFile").files[0];

  let finalImageUrl = null;

  // ---- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ----
  if (file) {
    console.log("ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:", file.name);

    const fileName = `products/${Date.now()}_${file.name}`;

    const { data: uploadData, error: uploadError } = await supabase.storage
      .from("products-images")
      .upload(fileName, file);

    if (uploadError) {
      console.error("âŒ Ø®Ø·Ø£ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:", uploadError);
      alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© âš ï¸");
      return;
    }

    const { data: urlData } = supabase.storage
      .from("products-images")
      .getPublicUrl(fileName);

    finalImageUrl = urlData.publicUrl;

    console.log("âœ”ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:", finalImageUrl);
  } else {
    console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©");
  }

  // ---- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ ----
  console.log("ğŸŸ¢ Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");

  const { data, error } = await supabase.from("products").insert([
    {
      title,
      description: desc,
      price,
      image_url: finalImageUrl,
    },
  ]);

  if (error) {
    console.error("âŒ Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬:", error);
    alert("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ âš ï¸ â€” Ø§Ù†Ø¸Ø± Console Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¨Ø¨");
    return;
  }

  console.log("âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬:", data);

  alert("âœ¨ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!");
  addProductForm.reset();
  loadAdmin();
});

  // --- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ products ---
  const { error } = await supabase.from('products').insert([{
    title,
    description: desc,
    price,
    image_url: finalImageUrl   // â† Ù‡Ù†Ø§ Ø§Ù„ØµÙˆØ±Ø© Ø£ØµØ¨Ø­Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  }]);

  if(error){
    console.error(error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬");
    return;
  }

  addProductForm.reset();
  loadAdmin();
  alert("âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
});


    refreshBtn.addEventListener('click', loadAdmin);

    // initial
    loadAdmin();

  </script>
</body>
</html>
